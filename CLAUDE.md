# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a C++17 implementation of a blockweave system (similar to Arweave), which is a blockchain variant that implements proof-of-access consensus. Unlike traditional blockchains, blockweave requires miners to access data from a randomly selected previous block ("recall block") during mining, incentivizing permanent data storage.

**Key Dependencies:**
- OpenSSL (for cryptographic hashing)
- CMake 3.10+
- C++17 compiler (GCC/Clang)

## Build Commands

### Initial Configuration and Build

```bash
# Configure the project (detects platform, dependencies, generator)
./configure

# Build (from project root)
cd build && make

# Or use CMake directly
mkdir -p build && cd build
cmake ..
make
```

### Build Targets

The project builds the following components:

1. **libblockweave_core.dylib** (or .so on Linux) - Shared library containing core blockchain code
2. **rest_daemon** - Main REST API daemon process
3. **wallet** - Wallet address generator utility
4. **daemon_cli** - Daemon control utility (start/stop/status/restart)

### Configure Options

```bash
# Debug build
./configure --debug

# Custom install prefix
./configure --prefix=/opt/restdaemon

# Specify build directory
./configure --build-dir=debug_build

# Use Ninja instead of Make
./configure --generator=Ninja
```

## Usage

### 1. Generate a Wallet Address

```bash
cd build
./wallet

# Output:
# === Blockweave Wallet Generator ===
# Generated Wallet Address:
# ea6dc2ca1bd34a376850629cc74510133b7c2a4c318...
```

### 2. Configure the Daemon

Edit `blockweave.conf` in the project root:

```
# Miner address (paste the address generated by ./wallet)
miner_address=ea6dc2ca1bd34a376850629cc74510133b7c2a4c318

# REST API port (default: 28443)
rest_api_port=28443

# Number of worker threads (default: 5)
worker_threads=5

# Data directory for blockchain storage
data_dir=./data

# Daemon mode (set by -d flag, don't modify manually)
daemon=false
```

### 3. Control the Daemon

```bash
cd build

# Start the daemon in background
./daemon_cli start

# Check daemon status
./daemon_cli status

# Stop the daemon
./daemon_cli stop

# Restart the daemon
./daemon_cli restart

# Start with custom config file
./daemon_cli start -c /path/to/custom.conf
```

### 4. Interact with the REST API

Once the daemon is running, use the REST API on port 28443:

```bash
# Get blockchain state
curl http://localhost:28443/chain

# Start mining
curl -X POST http://localhost:28443/mine/start

# Stop mining
curl -X POST http://localhost:28443/mine/stop
```

**REST API Endpoints:**

- `GET /chain` - Get blockchain state (mempool size, mining status)
- `POST /mine/start` - Start mining blocks
- `POST /mine/stop` - Stop mining blocks

### 5. Run Daemon in Foreground (for debugging)

```bash
cd build

# Run without daemon mode
./rest_daemon

# Run with custom config
./rest_daemon -c custom.conf

# Run in daemon mode manually
./rest_daemon -d
```

## Architecture

### Threading Model

The system uses multiple threads for concurrent operation:

1. **Main Thread** - Initializes components, waits for shutdown signal
2. **Mining Thread** - Continuously mines new blocks when enabled
3. **REST API Listener Thread** - Accepts incoming HTTP connections
4. **REST API Worker Threads** (5 by default) - Process HTTP requests from queue

All threads are synchronized using mutexes and atomic flags for thread-safe operation.

### Core Components

**CBlockweave** (src/blockweave.h, src/blockweave.cpp)
- Main orchestrator managing the entire blockweave structure (thread-safe)
- Maintains: block storage (`map_blocks`), block hash list (`m_block_hashes`), mempool
- Implements proof-of-access via `SelectRecallBlock()` which randomly selects historical blocks for mining
- Thread control: `StartMining()`, `StopMining()`, `IsMiningEnabled()`, `ShouldStopMining()`
- Key operations: `AddTransaction()`, `MineBlock()`, `GetBlock()`, `GetData()`, `GetMempoolSize()`
- Protected by mutex: `cs_blockweave` for thread-safe access

**CBlock** (src/block.h, src/block.cpp)
- Individual block representation with unique recall block mechanism
- Fields: `m_previous_block`, `m_recall_block` (proof-of-access), `m_n_cumulative_data_size`
- The `m_recall_block` field is what distinguishes this from traditional blockchain

**CTransaction** (src/transaction.h, src/transaction.cpp)
- Represents data storage transactions
- Each transaction carries arbitrary data (`m_data`) and has a reward (`m_n_reward`)
- Transaction IDs are computed as hashes

**CWallet** (src/wallet/wallet.h, src/wallet/wallet.cpp)
- Manages addresses and transaction creation
- Generates unique addresses on instantiation
- Located in src/wallet/ subfolder

**CHash** (src/utils/hash.h, src/utils/hash.cpp)
- Cryptographic hash wrapper using OpenSSL SHA-256
- Used for block hashes, transaction IDs, and proof-of-work
- Located in src/utils/ subfolder

**CRestApiServer** (src/rest_api.h, src/rest_api.cpp)
- Multi-threaded REST API server (fully integrated)
- Manages 1 listener thread + N worker threads (default: 5)
- Thread-safe request queue with condition variables
- Endpoints: GET /chain, POST /mine/start, POST /mine/stop

**CConfig** (src/cli/config.h, src/cli/config.cpp)
- Configuration file parser for blockweave.conf
- Reads: miner_address, rest_api_port, worker_threads, data_dir, daemon
- Key-value format: `key=value`

**CDaemon** (src/cli/daemon.h, src/cli/daemon.cpp)
- Unix daemon process management
- Handles: forking, session creation, signal handling, PID file management
- PID file location: `/tmp/rest_daemon.pid`
- Signal handlers for graceful shutdown (SIGTERM, SIGINT)

### Blockweave vs Blockchain

The key architectural difference is the **recall block mechanism**:
1. When mining, a block must reference both the previous block AND a randomly selected historical block
2. The recall block is selected using: `SelectRecallBlock(current_height)`
3. This forces miners to maintain historical data, creating permanent storage incentives
4. The randomization is deterministic based on the current block's properties

## Naming Conventions

Per `naming_convention.txt`, this codebase follows specific conventions:

- **Classes/Structs**: `C` prefix + CapitalizedName (e.g., `CBlock`, `CTransaction`)
- **Member variables**: `m_` prefix (e.g., `m_hash`, `m_n_height`)
- **Local variables**: snake_case
- **Functions/Methods**: CamelCase
- **Boolean variables**: `f` prefix
- **Numeric variables**: `n_` prefix
- **String variables**: `str_` prefix
- **Map variables**: `map_` prefix
- **Global variables**: `g_` prefix
- **Static variables**: `s_` prefix
- **Constants**: ALL_CAPS_WITH_UNDERSCORES
- **Mutexes**: `cs_` prefix

When adding or modifying code, strictly adhere to these conventions.

## Platform Support

The build system (CMakeLists.txt + configure script) supports:
- **macOS**: Handles Homebrew OpenSSL paths (both ARM `/opt/homebrew` and Intel `/usr/local`)
- **Linux**: Uses system OpenSSL and pkg-config
- **Windows**: Configured but not currently tested in this environment

Platform-specific defines are set automatically:
- `PLATFORM_MACOS`
- `PLATFORM_LINUX`
- `PLATFORM_WINDOWS`

## Project Structure

```
src/
├── main.cpp                    # Main daemon entry point
├── daemon_cli.cpp              # Daemon control utility
├── block.cpp, block.h          # Block implementation
├── blockweave.cpp, blockweave.h # Blockweave orchestrator
├── transaction.cpp, transaction.h # Transaction implementation
├── rest_api.cpp, rest_api.h    # REST API server
├── cli/
│   ├── config.cpp, config.h    # Configuration file parser
│   └── daemon.cpp, daemon.h    # Daemon process management
├── wallet/
│   ├── wallet.cpp, wallet.h    # Wallet implementation
│   └── wallet_main.cpp         # Wallet generator executable
└── utils/
    └── hash.cpp, hash.h        # SHA-256 hash wrapper

blockweave.conf                 # Configuration file
CMakeLists.txt                  # Build configuration
```

## Development Notes

- **rest_daemon**: Runs as a background daemon process with REST API
- **daemon_cli**: Control utility for starting/stopping rest_daemon
- **wallet**: Standalone wallet address generator
- **libblockweave_core**: Shared library (dynamic linking) containing core blockchain code
- All source files include banner comments: `// ============= filename.ext =============`
- The project uses smart pointers (`std::shared_ptr`) for transaction and block management
- Thread-safe design with mutexes (`cs_` prefix) and atomic flags
- PID file location: `/tmp/rest_daemon.pid` (changed from `/var/run/` for permissions)
- REST API uses request queue with condition variables for worker thread synchronization

## Daemon Control

The `daemon_cli` utility provides process management:

**Commands:**
- `daemon_cli start [-c <config>]` - Start rest_daemon in background
- `daemon_cli stop` - Gracefully stop rest_daemon (SIGTERM)
- `daemon_cli status` - Check if rest_daemon is running
- `daemon_cli restart [-c <config>]` - Restart rest_daemon

**Implementation Details:**
- Uses `fork()` and `execl()` to start rest_daemon process
- Dynamically locates rest_daemon executable using `FindRestDaemon()`
- Searches: same directory as daemon_cli, ./rest_daemon, ./build/rest_daemon
- Checks PID file to verify daemon status
- Sends SIGTERM for graceful shutdown (10 second timeout)

## Configuration File

**blockweave.conf** supports the following settings:

| Setting | Description | Default |
|---------|-------------|---------|
| `miner_address` | Wallet address for mining rewards (REQUIRED) | - |
| `rest_api_port` | REST API server port | 28443 |
| `worker_threads` | Number of REST API worker threads | 5 |
| `data_dir` | Blockchain data storage directory | ./data |
| `daemon` | Daemon mode (managed by -d flag) | false |

**Example:**
```
miner_address=ea6dc2ca1bd34a376850629cc74510133b7c2a4c318
rest_api_port=28443
worker_threads=5
data_dir=./data
daemon=false
```
